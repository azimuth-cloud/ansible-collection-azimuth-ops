---
- name: Run prechecks
  include_tasks: prechecks.yml

- name: Make Terraform project directory
  file:
    path: "{{ inventory_dir }}/.terraform"
    state: directory

- name: Copy Terraform files into project directory
  copy:
    src: "{{ item }}"
    dest: "{{ inventory_dir }}/.terraform"
  loop:
    - outputs.tf
    - providers.tf
    - variables.tf

- name: Copy Terraform files into project directory
  copy:
    src: "{% if capi_manager_existing_network_name is defined %}resources_existing_network.tf{% else %}resources.tf{% endif %}"
    dest: "{{ inventory_dir }}/.terraform/resources.tf"

- name: Provision infrastructure
  import_role:
    name: stackhpc.terraform.infra
  environment:
    OS_CLIENT_CONFIG_FILE: "{{ openstack_clouds_file }}"
    OS_CLOUD: openstack
  vars:
    # Variables controlling the Terraform provisioning
    terraform_project_path: "{{ inventory_dir }}/.terraform"
    terraform_variables:
      cluster_name: "{{ capi_manager_name }}"
      existing_network_name: "{{ capi_manager_existing_network_name | default(omit) }}"
      network_cidr: "{{ capi_manager_network_cidr | default(omit) }}"
      image_id: "{{ capi_manager_image_id }}"
      flavor_id: "{{ capi_manager_flavor_id }}"
      external_network_id: "{{ capi_manager_external_network_id }}"
      data_volume_size: "{{ capi_manager_data_volume_size }}"
      floatingip_pool: "{{ capi_manager_floatingip_pool }}"
